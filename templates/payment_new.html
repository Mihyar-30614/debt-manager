{{define "payment_new_content"}}
<div class="breadcrumb">
  <a href="/">Dashboard</a> → <a href="/payments">Payments</a> → Record payment
</div>
<div class="row">
  <div>
    <h1>Record payment</h1>
    <p>Record a payment for any active debt.</p>
  </div>
  <div class="page-actions">
    <a href="/payments" class="btn ghost">← Payments</a>
    <a href="/" class="btn ghost">Dashboard</a>
  </div>
</div>

<div class="spacer"></div>

{{if .ActiveDebts}}
<div class="card">
  <form method="POST" action="/payments/add" id="payment-form">
    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
    <input type="hidden" name="redirect_to" value="payments" />

    <div class="formgrid cols-3">
      <div>
        <label>Debt</label>
        <select name="debt_id" id="payment-debt" required autofocus>
          <option value="">Select debt...</option>
          {{range .ActiveDebts}}
          <option
            value="{{.ID}}"
            data-min="{{.MinPaymentCents}}"
            data-balance="{{.BalanceCents}}"
          >
            {{.Name}} ({{money .BalanceCents}})
          </option>
          {{end}}
        </select>
      </div>
      <div>
        <label>Date</label>
        <input name="paid_on" type="date" id="payment-date" required />
      </div>
      <div>
        <label>Amount ($)</label>
        <div style="display: flex; gap: 8px; align-items: flex-start">
          <input
            name="amount_dollars"
            type="number"
            step="0.01"
            min="0.01"
            id="payment-amount"
            required
            placeholder="0.00"
            style="flex: 1"
          />
          <button
            type="button"
            class="btn ghost"
            id="payment-min-btn"
            style="white-space: nowrap; padding: 0 12px"
            onclick="setMinPayment()"
          >
            Min
          </button>
          <button
            type="button"
            class="btn ghost"
            id="payment-max-btn"
            style="white-space: nowrap; padding: 0 12px"
            onclick="setMaxPayment()"
          >
            Max
          </button>
        </div>
      </div>
    </div>

    <div class="spacer"></div>

    <div>
      <label>Note</label>
      <input name="note" placeholder="Optional payment note" />
    </div>

    <div class="spacer"></div>

    <button class="btn primary" type="submit">Record payment</button>
  </form>
</div>
<script>
  // Set today's date as default
  document.getElementById("payment-date").valueAsDate = new Date();

  const debtSelect = document.getElementById("payment-debt");
  const amountInput = document.getElementById("payment-amount");
  const minBtn = document.getElementById("payment-min-btn");
  const maxBtn = document.getElementById("payment-max-btn");

  // Enable/disable buttons based on debt selection
  function updateButtonStates() {
    const selectedOption = debtSelect.options[debtSelect.selectedIndex];
    const hasDebtSelected = selectedOption.value && selectedOption.dataset.min && selectedOption.dataset.balance;
    minBtn.disabled = !hasDebtSelected;
    maxBtn.disabled = !hasDebtSelected;
  }

  // Update button states when debt selection changes
  debtSelect.addEventListener("change", updateButtonStates);
  updateButtonStates(); // Initial state

  function setMinPayment() {
    const selectedOption = debtSelect.options[debtSelect.selectedIndex];
    if (!selectedOption.value || !selectedOption.dataset.min || !selectedOption.dataset.balance) {
      return;
    }
    const minCents = parseInt(selectedOption.dataset.min, 10);
    const balanceCents = parseInt(selectedOption.dataset.balance, 10);
    if (isNaN(minCents) || isNaN(balanceCents) || minCents < 0 || balanceCents < 0) {
      return;
    }
    // Min payment is the smaller of min payment and balance (can't pay more than balance)
    const minAmount = Math.min(minCents, balanceCents) / 100.0;
    amountInput.value = minAmount.toFixed(2);
  }

  function setMaxPayment() {
    const selectedOption = debtSelect.options[debtSelect.selectedIndex];
    if (!selectedOption.value || !selectedOption.dataset.balance) {
      return;
    }
    const balanceCents = parseInt(selectedOption.dataset.balance, 10);
    if (isNaN(balanceCents) || balanceCents <= 0) {
      return;
    }
    const maxAmount = balanceCents / 100.0;
    amountInput.value = maxAmount.toFixed(2);
  }
</script>
{{else}}
<div class="card empty-state">
  <h3>No active debts</h3>
  <p>Add a debt first before recording payments.</p>
  <div class="page-actions" style="justify-content: center">
    <a href="/debts/new" class="btn primary">+ Add debt</a>
    <a href="/" class="btn ghost">Dashboard</a>
  </div>
</div>
{{end}} {{end}} {{define "payment_new.html"}}{{template "layout" .}}{{end}}

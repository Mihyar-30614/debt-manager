{{define "budget_view_content"}}
<div class="budget-breadcrumb">
  <a href="/budget">Budget</a> → {{monthName .Budget.Month}} {{.Budget.Year}}
</div>
<div class="row">
  <div>
    <h1>{{monthName .Budget.Month}} {{.Budget.Year}}</h1>
    <p>Set income and categories. Mark one as &quot;Extra for debt&quot; to see payoff plan suggestions.</p>
  </div>
  <div class="budget-actions">
    <a href="/budget" class="btn ghost">← All budgets</a>
    <a href="/plan" class="btn ghost">Payoff plan</a>
  </div>
</div>

<div class="spacer"></div>

<div class="card">
  <h2 style="margin-top: 0">Monthly income</h2>
  <form method="POST" action="/budget/update">
    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
    <input type="hidden" name="year" value="{{.Budget.Year}}" />
    <input type="hidden" name="month" value="{{.Budget.Month}}" />
    <div class="formgrid cols-2" style="max-width: 360px;">
      <div>
        <label>Income ($)</label>
        <input name="income_dollars" type="number" step="0.01" min="0" value="{{dollars .Budget.IncomeCents}}" placeholder="0" />
      </div>
      <div style="display: flex; align-items: flex-end;">
        <button type="submit" class="btn primary">Save income</button>
      </div>
    </div>
  </form>
</div>

<div class="spacer"></div>

<div class="row">
  <h2 style="margin: 0;">Categories</h2>
  <a href="/budget/category/add?budget_id={{.Budget.ID}}" class="btn primary">+ Add category</a>
</div>

{{if .Categories}}
<div class="card" style="margin-top: var(--space-3);">
  <div class="budget-categories-list">
    {{range .Categories}}
    <div class="budget-category-card">
      <div class="budget-category-card-main">
        <span class="budget-category-card-name">{{.Name}}</span>
        <span class="budget-category-card-remaining">
          {{$rem := sub .LimitCents .SpentCents}}
          {{if lt $rem 0}}<span class="badge bad">{{money $rem}}</span>{{else}}<span style="color: var(--good);">{{money $rem}}</span>{{end}}
        </span>
      </div>
      <div class="budget-category-card-meta">
        <span>Limit {{money .LimitCents}}</span>
        <span>Spent {{money .SpentCents}}</span>
      </div>
      {{$pct := pct .SpentCents .LimitCents}}
      <div class="budget-progress">
        <div class="budget-progress-fill {{if gt $pct 100}}over{{end}}" style="width: {{if gt $pct 100}}100{{else}}{{$pct}}{{end}}%;"></div>
      </div>
      <div class="budget-category-card-debt">
        {{if .IsDebtPayoff}}
        <span class="badge good">Extra for debt</span>
        {{if gt .SuggestedPayoffCents 0}}
        <span class="help">Suggested: {{money .SuggestedPayoffCents}}</span>
        {{end}}
        {{else}}
        <span style="color: var(--muted);">—</span>
        {{end}}
      </div>
      <div class="budget-category-card-actions budget-category-row budget-actions">
        <a href="/budget/expense/add?category_id={{.ID}}" class="btn">+ Expense</a>
        <a href="/budget/category/expenses?category_id={{.ID}}" class="btn">List</a>
        <a href="/budget/category/edit?id={{.ID}}" class="btn">Edit</a>
        <form method="POST" action="/budget/category/delete" style="margin:0;" onsubmit="return confirm('Delete this category and all its expenses?');">
          <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}" />
          <input type="hidden" name="id" value="{{.ID}}" />
          <button class="btn danger" type="submit">Delete</button>
        </form>
      </div>
    </div>
    {{end}}
  </div>
  <div class="table-wrapper budget-categories-table">
  <table>
    <thead>
      <tr>
        <th>Category</th>
        <th>Limit</th>
        <th>Spent</th>
        <th>Progress</th>
        <th>Remaining</th>
        <th>Debt link</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {{range .Categories}}
      <tr>
        <td><strong>{{.Name}}</strong></td>
        <td>{{money .LimitCents}}</td>
        <td>{{money .SpentCents}}</td>
        <td>
          {{$pct := pct .SpentCents .LimitCents}}
          <div class="budget-progress">
            <div class="budget-progress-fill {{if gt $pct 100}}over{{end}}" style="width: {{if gt $pct 100}}100{{else}}{{$pct}}{{end}}%;"></div>
          </div>
        </td>
        <td>
          {{$rem := sub .LimitCents .SpentCents}}
          {{if lt $rem 0}}<span class="badge bad">{{money $rem}}</span>{{else}}<span style="color: var(--good);">{{money $rem}}</span>{{end}}
        </td>
        <td>
          {{if .IsDebtPayoff}}
          <span class="badge good">Extra for debt</span>
          {{if gt .SuggestedPayoffCents 0}}
          <div class="help" style="margin-top: 4px;">Suggested: {{money .SuggestedPayoffCents}}</div>
          {{end}}
          {{else}}
          <span style="color: var(--muted);">—</span>
          {{end}}
        </td>
        <td>
          <div class="budget-category-row budget-actions">
            <a href="/budget/expense/add?category_id={{.ID}}" class="btn">+ Expense</a>
            <a href="/budget/category/expenses?category_id={{.ID}}" class="btn">List</a>
            <a href="/budget/category/edit?id={{.ID}}" class="btn">Edit</a>
            <form method="POST" action="/budget/category/delete" style="margin:0;" onsubmit="return confirm('Delete this category and all its expenses?');">
              <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}" />
              <input type="hidden" name="id" value="{{.ID}}" />
              <button class="btn danger" type="submit">Delete</button>
            </form>
          </div>
        </td>
      </tr>
      {{end}}
    </tbody>
  </table>
  </div>
</div>
{{else}}
<div class="card empty-state" style="margin-top: var(--space-3);">
  <h3>Add your first category</h3>
  <p>Categories like Groceries, Rent, or Debt payoff help you see where your money goes. Set a limit for each; you can mark one as &quot;Extra for debt&quot; to connect it to your payoff plan.</p>
  <a href="/budget/category/add?budget_id={{.Budget.ID}}" class="btn primary">+ Add first category</a>
</div>
{{end}}

{{if and (gt .Budget.IncomeCents 0) (gt .MinPaymentsSum 0)}}
<div class="spacer"></div>
<div class="budget-callout">
  <div class="label">Suggested extra for debt</div>
  <div class="value">{{money .SuggestedExtra}}</div>
  <p style="margin: var(--space-3) 0 0; font-size: 13px; color: var(--muted);">Income − category limits − minimums. Use on <a href="/plan" class="link">Payoff plan</a> as monthly budget = minimums + this.</p>
</div>
{{end}}
{{end}}
{{define "budget_view.html"}}{{template "layout" .}}{{end}}
